stages:
  - build
  - deploy

variables:
  IMAGE: "registry.gitlab.com/$CI_PROJECT_PATH/webbooks"

before_script:
  - echo "Using Kubernetes context: $(kubectl config current-context)"

build-image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: "1"
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_CERT_PATH: "/certs/client"
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - cd apps/webbooks
    - docker build -t $IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $IMAGE:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE:$CI_COMMIT_SHORT_SHA $IMAGE:latest
    - docker push $IMAGE:latest

deploy:
  stage: deploy
  image: alpine/k8s:1.30.0
  dependencies: []
  script:
    - apk add --no-cache curl
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yc CLI
    - curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n
    - export PATH="$PATH:/root/yandex-cloud/bin"
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ yc
    - yc config set token "$YC_TOKEN"
    - yc config set cloud-id "$YC_CLOUD_ID"
    - yc config set folder-id "$YC_FOLDER_ID"
    # –ü–æ–ª—É—á–µ–Ω–∏–µ kubeconfig
    - yc managed-kubernetes cluster get-credentials webbooks-k8s --external
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Helm
    - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    # –î–µ–ø–ª–æ–π
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - helm upgrade --install webbooks-db bitnami/postgresql \
        --set auth.postgresPassword=secretpassword \
        --set auth.database=webbooks
    - helm upgrade --install webbooks ./infra/k8s/webbooks \
        --set image.repository=$IMAGE \
        --set image.tag=$CI_COMMIT_SHORT_SHA
    # –ü–æ–ª—É—á–µ–Ω–∏–µ IP
    - |
      for i in $(seq 1 30); do
        IP=$(kubectl get svc webbooks -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
        if [ -n "$IP" ] && [ "$IP" != "<none>" ]; then
          echo "IP: $IP"
          break
        fi
        sleep 10
      done
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    - |
      MSG="‚úÖ WebBooks deployed!\\nüåê http://$IP:8080\\nüîñ Commit: $CI_COMMIT_SHORT_SHA"
      curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
        -d "chat_id=$TELEGRAM_CHAT_ID&text=$MSG&parse_mode=Markdown"
